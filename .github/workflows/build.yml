name: Build and Release

on:
  # å½“æ¨é€ v å¼€å¤´çš„ tag æ—¶è‡ªåŠ¨è§¦å‘å¹¶å‘å¸ƒåˆ° Releaseï¼ˆæ”¯æŒ v1.0.0ã€v1.0.0alpha1ã€v1.0.0-beta1 ç­‰ï¼‰
  push:
    tags:
      - 'v*'
  
  # æ‰‹åŠ¨è§¦å‘ç¼–è¯‘ï¼ˆä¸ä¸Šä¼ åˆ° Releaseï¼‰
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          $tag = "${{ github.ref }}"
          $version = $tag -replace 'refs/tags/v', ''
          Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$version"
          Write-Host "Extracted version: $version"
          
          # æ£€æµ‹æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆalpha, beta, rc ç­‰ï¼‰
          $isPrerelease = "false"
          if ($version -match '(?i)(alpha|beta|rc|pre)') {
            $isPrerelease = "true"
            Write-Host "This is a prerelease version"
          }
          Add-Content -Path $env:GITHUB_OUTPUT -Value "is_prerelease=$isPrerelease"
      
      - name: Setup AutoHotkey & Ahk2Exe (download)
        run: |
          $ahkVersion = "2.0.19"
          $headers = @{ "User-Agent" = "autoloot-ci" }
          $toolsRoot = Join-Path $env:RUNNER_TEMP "autoloot-tools"
          New-Item -ItemType Directory -Force -Path $toolsRoot | Out-Null

          # --- AutoHotkey ---
          $ahkZip = Join-Path $toolsRoot "AutoHotkey_$ahkVersion.zip"
          $ahkUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v$ahkVersion/AutoHotkey_$ahkVersion.zip"
          Write-Host "Downloading AutoHotkey v${ahkVersion}: $ahkUrl"
          Invoke-WebRequest -Uri $ahkUrl -OutFile $ahkZip -Headers $headers -ErrorAction Stop

          $ahkExtract = Join-Path $toolsRoot "AutoHotkey_$ahkVersion"
          if (Test-Path $ahkExtract) { Remove-Item -Recurse -Force $ahkExtract }
          Expand-Archive -Path $ahkZip -DestinationPath $ahkExtract -Force

          $ahk64Exe = Get-ChildItem -Path $ahkExtract -Recurse -Filter "AutoHotkey64.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $ahk64Exe) {
            Write-Error "AutoHotkey64.exe not found after extracting AutoHotkey_$ahkVersion.zip"
            Get-ChildItem -Path $ahkExtract -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 50 FullName | ForEach-Object { Write-Host "  $_" }
            exit 1
          }

          $ahkDir = Split-Path $ahk64Exe.FullName -Parent
          Add-Content -Path $env:GITHUB_ENV -Value "AHK_DIR=$ahkDir"
          Write-Host "AHK_DIR=$ahkDir"

          # --- Ahk2Exe ---
          # Ahk2Exe çš„ release tag å‘½åä¸ AutoHotkey ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå› æ­¤ä½¿ç”¨ latest release çš„ zip assetã€‚
          $ahk2ExeZip = Join-Path $toolsRoot "Ahk2Exe.zip"
          $latest = Invoke-RestMethod -Uri "https://api.github.com/repos/AutoHotkey/Ahk2Exe/releases/latest" -Headers $headers -ErrorAction Stop
          $asset = $latest.assets | Where-Object { $_.name -match '\.zip$' } | Select-Object -First 1
          if (-not $asset) {
            Write-Error "No .zip asset found in AutoHotkey/Ahk2Exe latest release"
            exit 1
          }
          $ahk2ExeUrl = $asset.browser_download_url
          Write-Host "Downloading Ahk2Exe: $ahk2ExeUrl"
          Invoke-WebRequest -Uri $ahk2ExeUrl -OutFile $ahk2ExeZip -Headers $headers -ErrorAction Stop

          $compilerExtract = Join-Path $toolsRoot "Ahk2Exe"
          if (Test-Path $compilerExtract) { Remove-Item -Recurse -Force $compilerExtract }
          Expand-Archive -Path $ahk2ExeZip -DestinationPath $compilerExtract -Force

          $compilerExe = Get-ChildItem -Path $compilerExtract -Recurse -Include "Ahk2Exe.exe","Aut2Exe.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $compilerExe) {
            Write-Error "Ahk2Exe.exe/Aut2Exe.exe not found after extracting Ahk2Exe.zip"
            Get-ChildItem -Path $compilerExtract -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 50 FullName | ForEach-Object { Write-Host "  $_" }
            exit 1
          }

          Add-Content -Path $env:GITHUB_ENV -Value "COMPILER_PATH=$($compilerExe.DirectoryName)"
          Add-Content -Path $env:GITHUB_ENV -Value "COMPILER_EXE=$($compilerExe.FullName)"
          Write-Host "COMPILER_EXE=$($compilerExe.FullName)"
      
      - name: Compile script to exe (64-bit)
        run: |
          $scriptPath = "${{ github.workspace }}\autoloot.ahk"
          $outputName = "autoloot"
          
          # ç›´æ¥ä» ref æå–ç‰ˆæœ¬å·ï¼ˆä¸ä¾èµ–æ­¥éª¤è¾“å‡ºï¼‰
          $isTagRef = "${{ github.ref }}"
          $tagName = "${{ github.ref_name }}"
          
          Write-Host "Git ref: $isTagRef"
          Write-Host "Tag name: $tagName"
          
          # å¦‚æœæ˜¯ tag å‘å¸ƒï¼Œä½¿ç”¨ç‰ˆæœ¬å·å‘½å
          if ($isTagRef -like "refs/tags/v*") {
            # ä» tag åç§°æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
            $version = $tagName -replace '^v', ''
            if ($version) {
              $outputName = "autoloot-v$version"
              Write-Host "Building release version: $outputName.exe (version: $version)"
            } else {
              Write-Host "Building development version: $outputName.exe (tag name: $tagName)"
            }
          } else {
            Write-Host "Building development version: $outputName.exe"
          }
          
          $outputPath = "${{ github.workspace }}\$outputName.exe"
          Write-Host "Output file will be: $outputPath"
          
          # æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®
          Write-Host "COMPILER_PATH environment variable: $env:COMPILER_PATH"
          Write-Host "COMPILER_EXE environment variable: $env:COMPILER_EXE"
          
          # å¦‚æœ COMPILER_EXE å·²ç»è®¾ç½®ï¼Œç›´æ¥ä½¿ç”¨
          if ($env:COMPILER_EXE -and (Test-Path $env:COMPILER_EXE)) {
            $compilerExe = $env:COMPILER_EXE
            Write-Host "Using compiler from COMPILER_EXE: $compilerExe"
          } elseif ($env:COMPILER_PATH) {
            # å¦åˆ™å°è¯•ä» COMPILER_PATH æŸ¥æ‰¾
            $compilerExe = "$env:COMPILER_PATH\Ahk2Exe.exe"
            if (-not (Test-Path $compilerExe)) {
              $compilerExe = "$env:COMPILER_PATH\Aut2Exe.exe"
            }
          } else {
            Write-Error "Compiler environment variables not set (COMPILER_EXE/COMPILER_PATH)."
            exit 1
          }
          
          if (-not (Test-Path $compilerExe)) {
            Write-Error "Compiler executable not found!"
            Write-Host "Searched paths:"
            Write-Host "  COMPILER_EXE: $env:COMPILER_EXE"
            Write-Host "  COMPILER_PATH\Ahk2Exe.exe: $env:COMPILER_PATH\Ahk2Exe.exe"
            Write-Host "  COMPILER_PATH\Aut2Exe.exe: $env:COMPILER_PATH\Aut2Exe.exe"
            exit 1
          }
          
          Write-Host "Using compiler: $compilerExe"
          
          # æŸ¥æ‰¾ AutoHotkey 64ä½ bin æ–‡ä»¶ï¼ˆç”¨äºç¼–è¯‘ï¼‰
          $ahkBinPath = $env:AHK_DIR
          if (-not $ahkBinPath) {
            Write-Error "AHK_DIR environment variable not set."
            exit 1
          }
          $binFile = Get-ChildItem -Path $ahkBinPath -Recurse -Filter "AutoHotkey*.bin" | Where-Object { $_.Name -like "*64*" -or $_.Name -like "*U64*" } | Select-Object -First 1
          
          if (-not $binFile) {
            Write-Warning "64-bit bin file not found, trying default..."
            $binFile = Get-ChildItem -Path $ahkBinPath -Recurse -Filter "*.bin" | Select-Object -First 1
          }
          
          # å‡†å¤‡ç¼–è¯‘å‚æ•°
          $compileArgs = @()
          $compileArgs += "/in"
          $compileArgs += "`"$scriptPath`""
          $compileArgs += "/out"
          $compileArgs += "`"$outputPath`""
          
          if ($binFile) {
            Write-Host "Using bin file: $($binFile.FullName)"
            $compileArgs += "/bin"
            $compileArgs += "`"$($binFile.FullName)`""
          } else {
            # å¦‚æœä¸æŒ‡å®š binï¼Œä½¿ç”¨ AutoHotkey 64ä½ exe ä½œä¸º base
            $ahk64Exe = "$ahkBinPath\AutoHotkey64.exe"
            if (Test-Path $ahk64Exe) {
              Write-Host "Using AutoHotkey64.exe as base: $ahk64Exe"
              $compileArgs += "/bin"
              $compileArgs += "`"$ahk64Exe`""
            } else {
              Write-Warning "No base file found, compiler will use default"
            }
          }
          
          # ä½¿ç”¨ç¼–è¯‘å™¨ç¼–è¯‘ï¼ˆ64ä½ï¼‰
          Write-Host "Compiling script to exe..."
          Write-Host "Command: $compilerExe $($compileArgs -join ' ')"
          
          # æ‰§è¡Œç¼–è¯‘å‘½ä»¤å¹¶æ•è·è¾“å‡º
          try {
            $process = Start-Process -FilePath $compilerExe -ArgumentList $compileArgs -Wait -PassThru -NoNewWindow -RedirectStandardOutput "$env:TEMP\compiler_output.txt" -RedirectStandardError "$env:TEMP\compiler_error.txt"
            
            # è¯»å–è¾“å‡º
            if (Test-Path "$env:TEMP\compiler_output.txt") {
              $output = Get-Content "$env:TEMP\compiler_output.txt" -Raw
              if ($output) {
                Write-Host "Compiler output:"
                Write-Host $output
              }
            }
            
            if (Test-Path "$env:TEMP\compiler_error.txt") {
              $compilerError = Get-Content "$env:TEMP\compiler_error.txt" -Raw
              if ($compilerError) {
                Write-Host "Compiler errors:"
                Write-Host $compilerError
              }
            }
            
            Write-Host "Compiler exit code: $($process.ExitCode)"
            
            if ($process.ExitCode -ne 0) {
              Write-Error "Compiler exited with code: $($process.ExitCode)"
            }
          } catch {
            Write-Error "Failed to execute compiler: $_"
            exit 1
          }
          
          # ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ–‡ä»¶å†™å…¥å®Œæˆ
          Start-Sleep -Seconds 2
          
          # éªŒè¯è¾“å‡ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (Test-Path $outputPath) {
            $fileSize = (Get-Item $outputPath).Length
            Write-Host "Build successful! File size: $([math]::Round($fileSize / 1KB, 2)) KB"
            Add-Content -Path $env:GITHUB_ENV -Value "OUTPUT_EXE=$outputName.exe"
          } else {
            Write-Error "Build failed! Output file not found at: $outputPath"
            Write-Host "Checking for output files in workspace..."
            Get-ChildItem -Path "${{ github.workspace }}" -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "Found: $($_.FullName) ($([math]::Round($_.Length / 1KB, 2)) KB)"
            }
            Write-Host "Checking script directory..."
            Get-ChildItem -Path (Split-Path $scriptPath) -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "Found: $($_.FullName) ($([math]::Round($_.Length / 1KB, 2)) KB)"
            }
            exit 1
          }
      
      - name: Generate checksum
        run: |
          # ä»ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼è·å–è¾“å‡ºæ–‡ä»¶å
          $outputFileName = $env:OUTPUT_EXE
          if (-not $outputFileName) {
            # å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œæ£€æŸ¥å·¥ä½œåŒºä¸­çš„ exe æ–‡ä»¶
            $isTagBuild = "${{ github.ref }}" -like "refs/tags/v*"
            $version = "${{ steps.version.outputs.version }}"
            
            if ($isTagBuild -and $version -ne "") {
              $outputFileName = "autoloot-v$version.exe"
            } else {
              # æŸ¥æ‰¾å·¥ä½œåŒºä¸­çš„ exe æ–‡ä»¶
              $foundExe = Get-ChildItem -Path "${{ github.workspace }}" -Filter "autoloot*.exe" | Select-Object -First 1
              if ($foundExe) {
                $outputFileName = $foundExe.Name
              } else {
                $outputFileName = "autoloot.exe"
              }
            }
            Write-Host "OUTPUT_EXE not set, using: $outputFileName"
          }
          
          $exePath = "${{ github.workspace }}\$outputFileName"
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path $exePath)) {
            Write-Error "Executable file not found: $exePath"
            Write-Host "Searching for exe files in workspace..."
            Get-ChildItem -Path "${{ github.workspace }}" -Filter "*.exe" | ForEach-Object {
              Write-Host "Found: $($_.FullName)"
            }
            exit 1
          }
          
          $checksumPath = "${{ github.workspace }}\$outputFileName.sha256"
          
          Write-Host "Generating SHA256 checksum for: $exePath"
          $hash = Get-FileHash -Path $exePath -Algorithm SHA256
          $checksum = "$($hash.Hash)  $outputFileName"
          Set-Content -Path $checksumPath -Value $checksum
          
          Write-Host "Checksum generated: $checksum"
          Add-Content -Path $env:GITHUB_ENV -Value "OUTPUT_EXE=$outputFileName"
      
      - name: Prepare Release
        if: startsWith(github.ref, 'refs/tags/v')
        id: prepare_release
        run: |
          # ä» tag æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          $tagName = "${{ github.ref_name }}"
          $version = $tagName -replace '^v', ''
          Write-Host "Release version: $version"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$version"
          
          # æ£€æµ‹æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          $isPrerelease = "false"
          if ($version -match '(?i)(alpha|beta|rc|pre)') {
            $isPrerelease = "true"
            Write-Host "This is a prerelease version"
          }
          Add-Content -Path $env:GITHUB_OUTPUT -Value "is_prerelease=$isPrerelease"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          $exeFile = "autoloot-v$version.exe"
          $shaFile = "$exeFile.sha256"
          $exePath = "${{ github.workspace }}\$exeFile"
          $shaPath = "${{ github.workspace }}\$shaFile"
          
          Write-Host "Checking for files:"
          Write-Host "  EXE: $exePath"
          Write-Host "  SHA: $shaPath"
          
          if (-not (Test-Path $exePath)) {
            Write-Error "Executable file not found: $exePath"
            Write-Host "Available .exe files in workspace:"
            Get-ChildItem -Path "${{ github.workspace }}" -Filter "*.exe" | ForEach-Object {
              Write-Host "  - $($_.Name) ($([math]::Round($_.Length / 1KB, 2)) KB)"
            }
            exit 1
          }
          
          if (-not (Test-Path $shaPath)) {
            Write-Error "Checksum file not found: $shaPath"
            Write-Host "Available .sha256 files in workspace:"
            Get-ChildItem -Path "${{ github.workspace }}" -Filter "*.sha256" | ForEach-Object {
              Write-Host "  - $($_.Name)"
            }
            exit 1
          }
          
          Write-Host "âœ“ Files verified successfully: $exeFile and $shaFile"
          
          # å°†æ–‡ä»¶åä¿å­˜åˆ°ç¯å¢ƒå˜é‡ä¾› Release æ­¥éª¤ä½¿ç”¨
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_EXE_FILE=$exeFile"
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_SHA_FILE=$shaFile"
          Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_VERSION=$version"
          Write-Host "Files to upload: $exeFile, $shaFile"
      
      - name: Create GitHub Release (tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ env.RELEASE_VERSION }}
          prerelease: ${{ steps.prepare_release.outputs.is_prerelease == 'true' }}
          body: |
            ## AutoLoot ${{ env.RELEASE_VERSION }}
            
            ${{ steps.prepare_release.outputs.is_prerelease == 'true' && 'âš ï¸ **This is a prerelease version**' || '' }}
            
            ### Downloads
            - **[${{ env.RELEASE_EXE_FILE }}](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.RELEASE_EXE_FILE }})**
            - [SHA256 Checksum](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.RELEASE_SHA_FILE }})
            
            ### Installation
            1. Download the `${{ env.RELEASE_EXE_FILE }}` file
            2. Run it directly (no installation required)
            3. Configure keys using `Ctrl+Alt+Shift+Key`
            
            ### Features
            - ğŸ® Multi-key support
            - âš¡ Anti-detection algorithms
            - ğŸ›ï¸ Real-time speed adjustment
            - ğŸ–¥ï¸ On-screen display
            - ğŸ’¾ Configuration persistence
          files: |
            ${{ env.RELEASE_EXE_FILE }}
            ${{ env.RELEASE_SHA_FILE }}
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          fail_on_unmatched_files: true
      
      - name: Upload artifact (manual build)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: autoloot-build
          path: |
            ${{ env.OUTPUT_EXE }}
            ${{ env.OUTPUT_EXE }}.sha256
          retention-days: 30
