name: Build and Release

on:
  # ÂΩìÊé®ÈÄÅ v ÂºÄÂ§¥ÁöÑ tag Êó∂Ëá™Âä®Ëß¶ÂèëÂπ∂ÂèëÂ∏ÉÂà∞ ReleaseÔºàÊîØÊåÅ v1.0.0„ÄÅv1.0.0alpha1„ÄÅv1.0.0-beta1 Á≠âÔºâ
  push:
    tags:
      - 'v*'
  
  # ÊâãÂä®Ëß¶ÂèëÁºñËØëÔºà‰∏ç‰∏ä‰º†Âà∞ ReleaseÔºâ
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          $tag = "${{ github.ref }}"
          $version = $tag -replace 'refs/tags/v', ''
          Write-Host "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Extracted version: $version"
          
          # Ê£ÄÊµãÊòØÂê¶‰∏∫È¢ÑÂèëÂ∏ÉÁâàÊú¨Ôºàalpha, beta, rc Á≠âÔºâ
          $isPrerelease = "false"
          if ($version -match '(?i)(alpha|beta|rc|pre)') {
            $isPrerelease = "true"
            Write-Host "This is a prerelease version"
          }
          Write-Host "is_prerelease=$isPrerelease" >> $env:GITHUB_OUTPUT
      
      - name: Setup AutoHotkey v2 compiler from repository
        run: |
          # ‰ΩøÁî®‰ª£Á†ÅÂ∫ì‰∏≠ÁöÑ AutoHotkeyÔºàÂ∑≤ÈÄöËøá Git LFS ‰∏ãËΩΩÔºâ
          $ahkRepoPath = "${{ github.workspace }}\AutoHotkey_2.0.19"
          
          if (-not (Test-Path $ahkRepoPath)) {
            Write-Error "AutoHotkey_2.0.19 directory not found in repository!"
            exit 1
          }
          
          Write-Host "Using AutoHotkey from repository: $ahkRepoPath"
          
          # Êü•Êâæ Aut2Exe.exeÔºàÂèØËÉΩÂú® Compiler Â≠êÁõÆÂΩï‰∏≠ÔºåÊàñËÄÖÈúÄË¶ÅÂÆâË£ÖÔºâ
          $compilerPath = "$ahkRepoPath\Compiler"
          $aut2ExePath = "$compilerPath\Aut2Exe.exe"
          
          # Â¶ÇÊûú Compiler ÁõÆÂΩï‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïËøêË°åÂÆâË£ÖËÑöÊú¨‰∏ãËΩΩÁºñËØëÂô®
          if (-not (Test-Path $compilerPath)) {
            Write-Host "Compiler directory not found, attempting to install Ahk2Exe..."
            
            # ‰ΩøÁî® AutoHotkey ËøêË°åÂÆâË£ÖËÑöÊú¨
            $installScript = "$ahkRepoPath\UX\install-ahk2exe.ahk"
            if (Test-Path $installScript) {
              $ahkExe = "$ahkRepoPath\AutoHotkey64.exe"
              if (Test-Path $ahkExe) {
                # ÈùôÈªòËøêË°åÂÆâË£ÖËÑöÊú¨ÔºàÈúÄË¶ÅÁÆ°ÁêÜÂëòÊùÉÈôêÊàñÁî®Êà∑ÂÆâË£ÖÔºâ
                Write-Host "Running Ahk2Exe installer..."
                Start-Process -FilePath $ahkExe -ArgumentList "`"$installScript`"", "-Y" -Wait -NoNewWindow
                
                # Á≠âÂæÖ‰∏Ä‰∏ãËÆ©ÂÆâË£ÖÂÆåÊàê
                Start-Sleep -Seconds 3
              }
            }
          }
          
          # ÂÜçÊ¨°Ê£ÄÊü•ÁºñËØëÂô®ÊòØÂê¶Â≠òÂú®
          if (Test-Path $aut2ExePath) {
            Write-Host "Compiler found at: $compilerPath"
            Write-Host "COMPILER_PATH=$compilerPath" >> $env:GITHUB_ENV
          } else {
            # Â¶ÇÊûúËøòÊòØÊâæ‰∏çÂà∞ÔºåÂ∞ùËØï‰ªé GitHub ‰∏ãËΩΩÁºñËØëÂô®
            Write-Host "Compiler not found, downloading from GitHub..."
            
            # ‰∏ãËΩΩÁºñËØëÂô® ZIP Êñá‰ª∂
            $compilerUrl = "https://github.com/AutoHotkey/Ahk2Exe/releases/latest/download/Ahk2Exe.zip"
            $compilerZip = "$env:TEMP\Ahk2Exe.zip"
            
            Invoke-WebRequest -Uri $compilerUrl -OutFile $compilerZip
            Expand-Archive -Path $compilerZip -DestinationPath $compilerPath -Force
            
            if (Test-Path $aut2ExePath) {
              Write-Host "Compiler downloaded and extracted successfully"
              Write-Host "COMPILER_PATH=$compilerPath" >> $env:GITHUB_ENV
            } else {
              Write-Error "Failed to find or download Aut2Exe.exe!"
              exit 1
            }
          }
      
      - name: Compile script to exe (64-bit)
        run: |
          $scriptPath = "${{ github.workspace }}\autoloot.ahk"
          $outputName = "autoloot"
          
          # Â¶ÇÊûúÊòØ tag ÂèëÂ∏ÉÔºå‰ΩøÁî®ÁâàÊú¨Âè∑ÂëΩÂêç
          if ("${{ steps.version.outputs.version }}" -ne "") {
            $outputName = "autoloot-v${{ steps.version.outputs.version }}"
            Write-Host "Building release version: $outputName.exe"
          } else {
            Write-Host "Building development version: $outputName.exe"
          }
          
          $outputPath = "${{ github.workspace }}\$outputName.exe"
          
          # Êü•Êâæ AutoHotkey 64‰Ωç bin Êñá‰ª∂ÔºàÁî®‰∫éÁºñËØëÔºâ
          $binFile = Get-ChildItem -Path "$env:COMPILER_PATH" -Recurse -Filter "AutoHotkey*.bin" | Where-Object { $_.Name -like "*64*" -or $_.Name -like "*U64*" } | Select-Object -First 1
          
          if (-not $binFile) {
            Write-Warning "64-bit bin file not found, trying default..."
            $binFile = Get-ChildItem -Path "$env:COMPILER_PATH" -Recurse -Filter "*.bin" | Select-Object -First 1
          }
          
          if ($binFile) {
            Write-Host "Using bin file: $($binFile.FullName)"
          }
          
          # ‰ΩøÁî® Aut2Exe ÁºñËØëÔºà64‰ΩçÔºâ
          # /in: ËæìÂÖ•ËÑöÊú¨Êñá‰ª∂
          # /out: ËæìÂá∫ exe Êñá‰ª∂
          # /bin: ÊåáÂÆö bin Êñá‰ª∂Ë∑ØÂæÑÔºà64‰ΩçÔºâ
          Write-Host "Compiling script to exe..."
          
          if ($binFile) {
            & "$env:COMPILER_PATH\Aut2Exe.exe" /in "$scriptPath" /out "$outputPath" /bin "$($binFile.FullName)"
          } else {
            # Â¶ÇÊûú‰∏çÊåáÂÆö binÔºå‰ΩøÁî®ÈªòËÆ§ÔºàÈÄöÂ∏∏ÊòØ64‰ΩçÔºâ
            & "$env:COMPILER_PATH\Aut2Exe.exe" /in "$scriptPath" /out "$outputPath"
          }
          
          if (Test-Path $outputPath) {
            $fileSize = (Get-Item $outputPath).Length
            Write-Host "Build successful! File size: $([math]::Round($fileSize / 1KB, 2)) KB"
            Write-Host "OUTPUT_EXE=$outputName.exe" >> $env:GITHUB_ENV
          } else {
            Write-Error "Build failed! Output file not found."
            exit 1
          }
      
      - name: Generate checksum
        run: |
          $exePath = "${{ github.workspace }}\$env:OUTPUT_EXE"
          $checksumPath = "${{ github.workspace }}\$env:OUTPUT_EXE.sha256"
          
          Write-Host "Generating SHA256 checksum..."
          $hash = Get-FileHash -Path $exePath -Algorithm SHA256
          $checksum = "$($hash.Hash)  $env:OUTPUT_EXE"
          Set-Content -Path $checksumPath -Value $checksum
          
          Write-Host "Checksum: $checksum"
      
      - name: Create GitHub Release (tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.version }}
          prerelease: ${{ steps.version.outputs.is_prerelease == 'true' }}
          body: |
            ## AutoLoot ${{ steps.version.outputs.version }}
            
            ${{ steps.version.outputs.is_prerelease == 'true' && '‚ö†Ô∏è **This is a prerelease version**' || '' }}
            
            ### Downloads
            - **[autoloot-${{ steps.version.outputs.version }}.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/autoloot-${{ steps.version.outputs.version }}.exe)**
            - [SHA256 Checksum](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/autoloot-${{ steps.version.outputs.version }}.exe.sha256)
            
            ### Installation
            1. Download the `autoloot-${{ steps.version.outputs.version }}.exe` file
            2. Run it directly (no installation required)
            3. Configure keys using `Ctrl+Alt+Shift+Key`
            
            ### Features
            - üéÆ Multi-key support
            - ‚ö° Anti-detection algorithms
            - üéõÔ∏è Real-time speed adjustment
            - üñ•Ô∏è On-screen display
            - üíæ Configuration persistence
          files: |
            ${{ env.OUTPUT_EXE }}
            ${{ env.OUTPUT_EXE }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact (manual build)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: autoloot-build
          path: |
            ${{ env.OUTPUT_EXE }}
            ${{ env.OUTPUT_EXE }}.sha256
          retention-days: 30
